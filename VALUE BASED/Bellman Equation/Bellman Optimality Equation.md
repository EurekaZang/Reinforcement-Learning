
you will learn:
1. core concept: **Optimal State Value** and **Optimal Policy**
2. vital tool: **Bellman Optimality Equation**

Motivating exï¼š***HOW TO IMPROVE POLICY***
![[Pasted image 20250120102310.png]]
åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬å¯ä»¥å¾ˆå¿«åœ°ç®—å‡ºæ¥æ¯ä¸ªstatesçš„state valueï¼Œç„¶åæ ¹æ®å…¬å¼ç®—å‡ºæ¥æ¯ä¸ªstatesçš„5ä¸ªaction value
åˆ†åˆ«æ˜¯ï¼š$$v_\pi(s_4) = v_\pi(s_3) = v_\pi(s_2) = 10, v_\pi(s_1) = 8.$$ç„¶åå¯ä»¥è®¡ç®—å‡ºæ¯ä¸€ä¸ªstateçš„action valueï¼Œè¿™é‡Œåªç»™å‡º $s_1$ çš„å…¨éƒ¨action valueï¼š$$
\begin{aligned}
q_\pi(s_1, a_1) &= -1 + \gamma v_\pi(s_1) = 6.2, \\
q_\pi(s_1, a_2) &= -1 + \gamma v_\pi(s_2) = 8, \\
q_\pi(s_1, \color{lime}{a_3}) &= 0 + \gamma v_\pi(s_3) = \color{lime}{9}, \\
q_\pi(s_1, a_4) &= -1 + \gamma v_\pi(s_1) = 6.2, \\
q_\pi(s_1, a_5) &= 0 + \gamma v_\pi(s_1) = 7.2.
\end{aligned}
$$æƒ³è¦çŸ¥é“æ€ä¹ˆæ”¹è¿›ç­–ç•¥ï¼Œè¦å…ˆçŸ¥é“å½“å‰ç­–ç•¥ï¼š$$
\pi(a|s_1) = \begin{cases}
1 & a = a_2 \\
0 & a \neq a_2
\end{cases}
$$é€šè¿‡ä¸Šé¢çš„è®¡ç®—å‘ç°ï¼Œ $a_3$ æ‹¥æœ‰æœ€å¤§çš„action value
è€Œæ–°çš„ç­–ç•¥ï¼ˆæ”¹è¿›åçš„ç­–ç•¥ï¼‰åº”è¯¥ä½¿ç”¨æœ‰æœ€å¤§çš„action valueçš„actionï¼Œæ‰€ä»¥ï¼š$$
\pi_{\text{new}}(a|s_1) = \begin{cases}
1 & a = a^* \\
0 & a \neq a^*
\end{cases}
$$å…¶ä¸­ï¼š$$
a^* = \arg \max_a q_\pi(s_1, a) = a_3.
$$
ä½†æ˜¯ï¼Œä¸€ä¸ªå¤æ‚çš„é—®é¢˜ä¸­ç»è¿‡ä¸€æ¬¡ evaluation-improvement åå¯èƒ½è¿˜æ˜¯æ²¡æœ‰è¾¾åˆ°æœ€ä¼˜ç­–ç•¥ï¼Œæ‰€ä»¥éœ€è¦è¿­ä»£å¤šæ¬¡ã€‚

**( ! )** å®šä¹‰policyçš„å¥½åï¼šå¦‚æœ$$
v_{\pi_1}(s) \geq v_{\pi_2}(s) \quad \text{for all } s \in \mathcal{S}
$$***ä¼˜ç­–ç•¥ä¸­æ¯ä¸€ä¸ªstateçš„state valueéƒ½æ¯”åŠ£ç­–ç•¥å¤§***ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯´ $\pi_1$ is better than $\pi_2$

# ç°åœ¨è®² è´å°”æ›¼æœ€ä¼˜å…¬å¼
ç›´æ¥ç»™å…¬å¼ï¼š$$
\begin{aligned}
v(s) &= \max_{\pi} \sum_a \pi(a|s) \left( \sum_r p(r|s,a)r + \gamma \sum_{s'} p(s'|s,a)v(s') \right), \quad \forall s \in \mathcal{S}\\
&= \max_{\pi} \sum_a \pi(a|s)q(s,a), \quad \forall s \in \mathcal{S}
\end{aligned}
$$ç›¸æ¯”è´å°”æ›¼å…¬å¼ï¼Œè´å°”æ›¼æœ€ä¼˜å…¬å¼åµŒå…¥äº†ä¸€ä¸ªä¼˜åŒ–é—®é¢˜ï¼Œ$\max_{\pi}(\text{Bellman Equation}(s))$ ä¹Ÿå°±æ˜¯è®©æ¯ä¸€ä¸ªstate valueéƒ½æœ€å¤§åŒ–ã€‚BOEä¸­çš„ç­–ç•¥ $\pi$ ä¸å†æ˜¯æ‰€æœ‰çš„ç­–ç•¥ï¼Œè€Œæ˜¯æœ€ä¼˜ç­–ç•¥ã€‚

ä¸Šé¢ç»™å‡ºçš„æ˜¯element wise formï¼Œç°åœ¨å°†matrix-vector wiseä¹Ÿç»™å‡ºï¼š$$v=\max_{\pi}(r_\pi+\gamma P_\pi v)$$
æ¥ä¸‹æ¥ï¼ŒçŸ¥é“äº†BOEï¼Œæ€ä¹ˆè§£ OPå’Œ OSVå‘¢ï¼Ÿæˆ‘ä»¬ç°åœ¨åªæœ‰ä¸€ä¸ªç­‰å¼BOEï¼Œå…¶ä¸­ $\pi$ æ˜¯æœªçŸ¥é‡ï¼Œ$v$ ä¹Ÿæ˜¯æœªçŸ¥é‡ã€‚ä¸€ä¸ªæ–¹ç¨‹èƒ½è§£ä¸¤ä¸ªæœªçŸ¥æ•°å—ï¼Ÿå¯ä»¥ã€‚å…ˆçœ‹è¿™ä¸ªä¾‹å­æ€ä¹ˆè§£ï¼š$$x=\max_a(2x-1-a^2)$$è¿™ä¸ªå¼å­è¦æ±‚æ±‚è§£ä¸¤ä¸ªæœªçŸ¥é‡ï¼Œä¸€ä¸ªæ˜¯ $a$ï¼Œä¸€ä¸ªæ˜¯ $x$ 
æˆ‘ä»¬çŸ¥é“ï¼Œ$-a^2$æ°¸è¿œæ˜¯ä¸ªè´Ÿæ•°ï¼Œé‚£ä¹ˆæƒ³è¦å¼å­æœ€å¤§ï¼Œå°±è®© $a=0$ ã€‚æœ‰ï¼š$$x=2x-1$$è½»æ¾è§£å¾— $x=1 \text{ and } a=0$ ã€‚

æˆ‘ä»¬å›æ¥çœ‹BOEï¼Œ$$\begin{aligned}
v(s) &= \max_{\pi} \sum_a \pi(a|s)q(s,a), \quad \forall s \in \mathcal{S}
\end{aligned}$$å—åˆ°ä¸Šè¿°ä¾‹å­çš„å¯å‘ï¼Œæˆ‘ä»¬æƒ³ä¼˜å…ˆç¡®å®š $\pi$ï¼Œç„¶åå†å°†ç¡®å®šçš„ $\pi$ åå¸¦å›å»è®¡ç®— $v$ ã€‚
æˆ‘ä»¬å‡è®¾ä¸€ä¸ªstateåªæœ‰3ä¸ªactionå¯é€‰ï¼Œä¸”å°† $\pi(a_i|s_j)$ ç®€å†™ä¸º $c_i$ï¼Œå°† $q(s,a_i)$ ç®€å†™ä¸º $q_i$ï¼Œå‡è®¾ $q_3>q_2,q_1$ ï¼š $$\max_{c_1,c_2,c_3}c_1q_1+c_2q_2+c_3q_3$$
å…¶ä¸­ $c_1+c_2+c_3 = 1$ ä¸” $c_1ï¼Œc_2ï¼Œc_3>0$ 
***ç»“è®º***ï¼šè‹¥æƒ³è¦è¯¥å¼æœ€å¤§ï¼Œåˆ™Let $c_3 = 1,c_2 = c_1 = 0$ ã€‚ç»“è®ºè¯æ˜ï¼š 
$$
\begin{aligned}
q_3 = (c_1 + c_2 + c_3)q_3 = c_1q_3 + c_2q_3 + c_3q_3 &\geq c_1q_1 + c_2q_2 + c_3q_3\\
q_3 &\geq c_1q_1 + c_2q_2 + c_3q_3\\
0Ã—q_1+0Ã—q_2+1Ã—q_3 &\geq c_1q_1 + c_2q_2 + c_3q_3.
\end{aligned}
$$
æ‰€ä»¥ $\pi(a|s)=c_3=1$ï¼Œå¾—åˆ°ï¼š$$\max_{\pi} \sum_{a} \pi(a|s) q(s, a) = \max_{a \in \mathcal{A}(s)} q(s, a),$$
ä¸‹é¢å¼€å§‹æ­£å¼æ±‚è§£ BOE
The BOE is $$v=\max_\pi(r_\pi+\gamma P_\pi v)$$Let: $$f(v)=\max_\pi(r_\pi+\gamma P_\pi v)$$We have the BOE described as: $$v=f(v)$$Fix pointã€‚
ä½†ä¸ºäº†ç¬”è®°å®Œæ•´æ€§ï¼Œå…ˆè®²è®²**Contraction Mapping Theorem**
1. Fix point ä¸åŠ¨ç‚¹ï¼Œä¸å†è¿‡å¤šèµ˜è¿°ï¼Œç»™å®šä¹‰å…¬å¼ï¼š $$x\in X \text{ is a fixed point of} f:X \rightarrow X \text{ if } f(x)=x$$
2. Contraction mapping: $f$ is a contraction mapping if $$\|f(x_1)-f(x_2)\|\le \gamma\|x_1-x_2\|$$ç›´è§‚ç†è§£è¿™ä¸ªå…¬å¼ï¼š![[b35b944bf39d0f854202cd3e8d746fe.jpg]]ä¹Ÿå°±æ˜¯è¯´ç»è¿‡è¿™ä¸ªmappingä¹‹åï¼Œ $x_1$ å’Œ $x_2$ ä¹‹é—´çš„æ¬§å¼è·ç¦»æ›´çŸ­äº†ã€‚
äº†è§£äº†Fixed pointå’Œcontraction mappingä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½ç†è§£å¤§åé¼é¼çš„ ***Contraction mapping theorem***
==å¯¹äºä»»ä½•å…¬å¼ç¬¦åˆ $x=f(x)$ï¼Œä¸” $f(x)$ æ˜¯ä¸€ä¸ªcontraction mappingçš„ç­‰å¼ï¼Œæœ‰ï¼š==
1. å­˜åœ¨æ€§ï¼šä¸€å®šå­˜åœ¨ä¸€ä¸ª $x^*$ æ»¡è¶³ $f(x^*)=x^*$ 
2. ç‹¬ç‰¹æ€§ï¼šè¿™ä¸ª $x^*$ æ˜¯å”¯ä¸€çš„
3. æ±‚è§£ $x^*$ ç®—æ³•ï¼šè€ƒè™‘ä¸€ä¸ªæ»¡è¶³ $x_{k+1}=f(x_k)$ çš„åºåˆ— $\{x_k\}$ï¼Œæœ‰ $x_k \rightarrow x^*$ å½“ä¸”ä»…å½“ $k \rightarrow +\infty$ã€‚è€Œä¸”ï¼Œæ”¶æ•›é€Ÿåº¦æ˜¯æŒ‡æ•°çº§çš„ã€‚
å¯¹äºBOEï¼Œå¯ä»¥è¯æ˜ $f(v)=\max_\pi(r_\pi+\gamma P_\pi v)$ æ˜¯ä¸€ä¸ªcontraction mappingï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“ä¸€å®šå­˜åœ¨ä¸€ä¸ªæœ€ä¼˜è§£ $v^*$ï¼Œä¸”ç»è¿‡ä¸€äº›è¿­ä»£å°±èƒ½æ±‚å‡ºè¿™ä¸ªOSVã€‚

æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹è´å°”æ›¼æœ€ä¼˜å…¬å¼çš„è§£çš„æœ€ä¼˜æ€§ï¼š
ç”±äºæˆ‘ä»¬å¯ä»¥è§£å‡ºæ¯ä¸€ä¸ªstateçš„æœ€ä¼˜çŠ¶æ€å€¼ $v^*$ $$v^* = \max_{\pi}(r_\pi + \gamma P_\pi v^*)$$æŒ‰ç…§å‰é¢çš„ä¾‹å­ï¼Œå›ºå®šäº† $v^*$ ä¹‹åå°±å¯ä»¥è§£æœ€ä¼˜ç­–ç•¥ $\pi^*$ï¼Œå…·ä½“ï¼š
$$\pi^* = \arg \max_{\pi}(r_\pi + \gamma P_\pi v^*)$$æœ€åå°†æœ€ä¼˜ç­–ç•¥å¸¦è¿›ä¸€ä¸ªè´å°”æ›¼å…¬å¼ï¼š
$$v^* = r_{\pi^*} + \gamma P_{\pi^*} v^*$$è¿™å°±æ˜¯*æœ€ä¼˜ç­–ç•¥çš„è´å°”æ›¼å…¬å¼*ã€‚å‰é¢è¯´äº†ï¼Œæœ€ä¼˜ç­–ç•¥ä¸‹æ¯ä¸€ä¸ªstateçš„state valueéƒ½è¦æ¯”å…¶ä»–ä»»ç­–ç•¥ä¸‹çš„state valueå¤§ï¼Œè¯æ˜ä¸å†ç»™å‡ºã€‚

æœ€ä¼˜ç­–ç•¥å…·ä½“é•¿ä»€ä¹ˆæ ·ï¼Ÿå‰é¢ä¹Ÿæåˆ°è¿‡äº†ï¼Œå¯¹äºä»»æ„ $s\in \mathcal{S}$ï¼š$$\pi^*(a|s) = \begin{cases} 1 & a = a^*(s) \\ 0 & a \neq a^*(s) \end{cases}$$
# ä¸€äº›å…³äºæ”¹å˜ ğœ¸ å’Œ r æœ€ä¼˜ç­–ç•¥ä¼šå‘ä»€ä¹ˆæ”¹å˜çš„ç»éªŒä¹‹è°ˆ
![[Pasted image 20250120200447.png]]è¿™å¼ å›¾ä¸­ğœ¸é€‰æ‹©çš„æ˜¯0.9ï¼Œä¼šå‘ç°agentæœ‰æ—¶ä¼šç›´æ¥ç©¿è¿‡forbidden areaç›´è¾¾ç»ˆç‚¹ã€‚è¿™æ˜¯å› ä¸ºåœ¨high-ğœ¸ caseä¸‹ï¼Œagentä¼šå˜å¾—è¿œè§†ï¼Œç©¿è¿‡forbidden areaå¸¦æ¥çš„discounted returnæ¯”ç»•è¿œè·¯å¸¦æ¥çš„æ›´å¤§ã€‚
![[Pasted image 20250120200832.png]]åœ¨è¿™å¼ å›¾ä¸­ï¼Œå…¶ä»–å‚æ•°æ²¡å˜ï¼Œåªæœ‰ğœ¸ä»0.9å˜æˆäº†0.5ã€‚æ­¤æ—¶discounted return çš„é åé¡¹å˜å¾—éå¸¸å°ï¼Œå¯¹æ€»ä½“çš„å½±å“å˜å¼±ï¼Œç›¸å¯¹ä¹‹ä¸‹è€ƒå‰é¡¹çš„å½±å“å˜å¾—æ›´å¼ºï¼Œagentå˜å¾—æ›´åŠ è¿‘è§†ã€‚æœ€ä¼˜ç­–ç•¥ä¸­çš„ç›´è§‚ä½“ç°å°±æ˜¯agentç»•å¼€äº†æ‰€æœ‰çš„forbidden areaã€‚
![[Pasted image 20250120205206.png]]è¿™å¼ å›¾ä¸­è¿›å…¥forbidden areaçš„rewardè¢«è®¾ç½®ä¸ºäº†-10ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œåœ¨æœ€ä¼˜ç­–ç•¥ä¸­ä½“ç°æ˜¯è™½ç„¶agentå¾ˆè¿œè§†ï¼Œä½†æ˜¯å®ƒæåŠ›é¿å…è¿›å…¥forbidden areaã€‚
æ­¤å¤–ï¼Œå¦‚æœå°†æ‰€æœ‰çš„ $r$ å˜æˆ $aÃ—r+b$ å‘¢ï¼Ÿç»“æœæ˜¯ä¸ä¼šå˜ï¼Œå› ä¸ºwhat matter is the ***relative values*** but not ***absolute values***.

# The END